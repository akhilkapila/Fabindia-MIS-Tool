{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-4 md:p-8 max-w-7xl relative">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Admin Portal</h1>
            <p class="text-gray-600">Manage all processing rules and users.</p>
        </div>
        <a href="/" class="text-blue-600 hover:text-blue-800 font-medium">&larr; Back to Main Tool</a>
    </div>

    <!-- Admin Tab Navigation -->
    <div class="mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button data-tab="Sales" onclick="openAdminTab(event, 'Sales')" class="tab-button active px-1 py-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                    Sales Rules
                </button>
                <button data-tab="Advances" onclick="openAdminTab(event, 'Advances')" class="tab-button px-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300">
                    Advances Rules
                </button>
                <button data-tab="Banking" onclick="openAdminTab(event, 'Banking')" class="tab-button px-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300">
                    Banking Rules
                </button>
                <button data-tab="UserManagement" onclick="openAdminTab(event, 'UserManagement')" class="tab-button px-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300">
                    User Management
                </button>
            </nav>
        </div>
    </div>

    <!-- Tab Content: Sales -->
    <div id="Sales" class="tab-content space-y-6">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Sales: Output Columns ({{ output_cols.sales.json | fromjson | length }})</h3>
            <form action="{{ url_for('save_output_columns', type='sales') }}" method="POST">
                <input type="hidden" name="active_tab" value="Sales">
                <textarea id="output-cols-sales" name="output_columns_sales" readonly rows="10" class="w-full p-3 border rounded-md font-mono text-xs bg-gray-50">{{ output_cols.sales.str }}</textarea>
                <div class="text-right mt-4">
                    <button type="button" id="edit-cols-sales" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md">Edit</button>
                    <button type="submit" id="save-cols-sales" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md hidden">Save Columns</button>
                </div>
            </form>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Sales: Rulebook</h3>
            <button onclick="openModal('sales')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">
                Edit Sales Rule
            </button>
        </div>
    </div>

    <!-- Tab Content: Advances -->
    <div id="Advances" class="tab-content space-y-6 hidden">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Advances: Output Columns ({{ output_cols.advances.json | fromjson | length }})</h3>
            <form action="{{ url_for('save_output_columns', type='advances') }}" method="POST">
                <input type="hidden" name="active_tab" value="Advances">
                <textarea id="output-cols-advances" name="output_columns_advances" readonly rows="10" class="w-full p-3 border rounded-md font-mono text-xs bg-gray-50">{{ output_cols.advances.str }}</textarea>
                <div class="text-right mt-4">
                    <button type="button" id="edit-cols-advances" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md">Edit</button>
                    <button type="submit" id="save-cols-advances" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md hidden">Save Columns</button>
                </div>
            </form>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Advances: Rulebook</h3>
            <button onclick="openModal('advances')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">
                Edit Advances Rule
            </button>
        </div>
    </div>

    <!-- Tab Content: Banking -->
    <div id="Banking" class="tab-content space-y-6 hidden">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Banking: Output Columns ({{ output_cols.banking.json | fromjson | length }})</h3>
            <form action="{{ url_for('save_output_columns', type='banking') }}" method="POST">
                <input type="hidden" name="active_tab" value="Banking">
                <textarea id="output-cols-banking" name="output_columns_banking" readonly rows="10" class="w-full p-3 border rounded-md font-mono text-xs bg-gray-50">{{ output_cols.banking.str }}</textarea>
                <div class="text-right mt-4">
                    <button type="button" id="edit-cols-banking" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md">Edit</button>
                    <button type="submit" id="save-cols-banking" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md hidden">Save Columns</button>
                </div>
            </form>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-700">Banking: Rulebook</h3>
                <button onclick="openModal('new_bank')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">
                    + Add New Bank Rule
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bank Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sheet Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Row</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for bank in banks %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ bank.bank_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">{{ bank.sheet_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ bank.start_row }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="openModal('edit_bank', {{ bank.id }})" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                <a href="{{ url_for('delete_bank', bank_id=bank.id) }}" onclick="return confirm('Are you sure you want to delete this bank rule?')" class="text-red-600 hover:text-red-900 ml-4">Delete</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No bank rules defined yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tab Content: User Management -->
    <div id="UserManagement" class="tab-content hidden">
        {% include '_admin_user_management.html' %}
    </div>

</div>

<!-- Modal (Re-styled) -->
<div id="ruleModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Background overlay -->
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>

        <!-- Modal Panel -->
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
            <form id="ruleForm" method="POST" action="">
                <input type="hidden" name="bank_id" id="bank_id" value="">
                <input type="hidden" name="active_tab" id="modal_active_tab" value="">
                
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modalTitle">Edit Rule</h3>
                    
                    <!-- Scrollable Content -->
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        
                        <!-- Bank Name Field -->
                        <div id="bank-name-field-wrapper" class="hidden">
                            <label for="bank_name" class="block text-sm font-medium text-gray-700">Bank Name</label>
                            <input type="text" id="bank_name" name="bank_name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>

                        <!-- General Config -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="start_row" class="block text-sm font-medium text-gray-700">Start Reading from Row</label>
                                <input type="number" id="start_row" name="start_row" value="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="sheet_name" class="block text-sm font-medium text-gray-700">Sheet Name</label>
                                <input type="text" id="sheet_name" name="sheet_name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., AMEX MIS">
                            </div>
                        </div>

                        <!-- Sales Special Rules -->
                        <div id="sales-special-rules" class="hidden space-y-4 p-4 bg-blue-50 rounded border border-blue-100">
                            <h4 class="text-sm font-bold text-blue-800 uppercase">Sales Special Rules</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Copy Column (Source)</label>
                                    <input type="text" id="copy_col_source" name="copy_col_source" class="mt-1 block w-full p-2 border border-gray-300 rounded-md sm:text-xs" placeholder="e.g., AlternateStoreCode">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Copy Column (Destination)</label>
                                    <input type="text" id="copy_col_dest" name="copy_col_dest" class="mt-1 block w-full p-2 border border-gray-300 rounded-md sm:text-xs" placeholder="e.g., StoreCode">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700">'BP' Removal Columns (comma-sep)</label>
                                <input type="text" id="bp_remove_cols" name="bp_remove_cols" class="mt-1 block w-full p-2 border border-gray-300 rounded-md sm:text-xs" placeholder="e.g., StoreCode,AlternateStoreCode">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Prefix Remove Col</label>
                                    <input type="text" id="prefix_remove_col" name="prefix_remove_col" class="mt-1 block w-full p-2 border border-gray-300 rounded-md sm:text-xs" placeholder="e.g., StoreCode">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Prefix Values</label>
                                    <input type="text" id="prefix_remove_values" name="prefix_remove_values" class="mt-1 block w-full p-2 border border-gray-300 rounded-md sm:text-xs" placeholder="e.g., 97,98">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advances Special Rules -->
                        <div id="advances-special-rules" class="hidden space-y-4 p-4 bg-green-50 rounded border border-green-100">
                            <h4 class="text-sm font-bold text-green-800 uppercase">Advances VLOOKUP Rules</h4>
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Adv Lookup Key</label>
                                    <input type="text" id="vlookup_source_col" name="vlookup_source_col" class="mt-1 block w-full p-2 border border-gray-300 rounded-md sm:text-xs" placeholder="e.g., Store">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Sales Lookup Key</label>
                                    <input type="text" id="vlookup_sales_col" name="vlookup_sales_col" class="mt-1 block w-full p-2 border border-gray-300 rounded-md sm:text-xs" placeholder="e.g., StoreName">
                                </div>
                            </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Dest Column</label>
                                    <input type="text" id="vlookup_dest_col" name="vlookup_dest_col" class="mt-1 block w-full p-2 border border-gray-300 rounded-md sm:text-xs" placeholder="e.g., Store Code">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Value Source Col</label>
                                    <input type="text" id="vlookup_value_col" name="vlookup_value_col" class="mt-1 block w-full p-2 border border-gray-300 rounded-md sm:text-xs" placeholder="e.g., StoreCode">
                                </div>
                            </div>
                        </div>

                        <!-- Column Mappings -->
                        <div>
                            <h4 class="text-sm font-bold text-gray-700 uppercase mb-2 border-b pb-1">Column Mappings</h4>
                            <div id="mappings" class="space-y-3">
                                <!-- JS injects rows here -->
                            </div>
                        </div>

                    </div>
                </div>
                
                <!-- Footer -->
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Save Rule
                    </button>
                    <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JSON data for JS -->
<script id="bank-data" type="application/json">{{ banks_json | safe }}</script>
<script id="sales-rule-data" type="application/json">{{ sales_rule_json | safe }}</script>
<script id="advance-rule-data" type="application/json">{{ advance_rule_json | safe }}</script>
<script id="output-cols-data" type="application/json">{{ output_cols | tojson | safe }}</script>
<script>
    // This passes the active tab from Python to JS for the tab refresh logic
    window.activeTab = {{ active_tab | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='admin.js') }}?v={{ cache_v }}"></script>
{% endblock %}